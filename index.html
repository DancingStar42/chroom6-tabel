<!DOCTYPE html>
<html lang="en">
<head>
        <title>Invultabel chroom-6 onderzoek</title>
         <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- **Zorgt voor goede schaalbaarheid op mobiel**  -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"> <!-- Bootstrap - Latest compiled and minified CSS -->
  
       <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.25.4/docxtemplater.js"></script>
        <script src="https://unpkg.com/pizzip@3.1.8/dist/pizzip.js"></script>
        <script src="https://unpkg.com/pizzip@3.1.8/dist/pizzip-utils.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
    
    <style>
    /* Tabel met constructies standaard verborgen, invullen projectnummer verplicht */
        #tabel{
            display:none;} 
            
    /* Zorg dat de inputvelden en dropdowns 100% breedte hebben op kleine schermen */
        .form-control, .btn {
            width: 100%;
            margin-bottom: 10px;
        }
    
    /* Opmaak radio buttons incl. labels */
        .materiaal-opties label {
            display: block-inline; /* Of terug naar block voor onder elkaar? */
            font-size: 16px;
            margin-bottom: 10px;
            padding: 4px;
        }

    /* Padding voor beter leesbare kleur invoervelden */
        .verf-kleuren input {
            padding: 8px;
            font-size: 16px;
        }

    /* De onderstaande CSS wordt alleen toegepast als het scherm maximaal 576 pixels breed (flexibele kolom) */
        @media (max-width: 576px) {
            .container { padding: 10px; }
            h3 { font-size: 20px; text-align: center; }
            .materiaal-opties { text-align: left; }
        }
            
    /* Verwijdert extra inspringing van nieuwe regels; overschrijft bootstrap */    
    .regel {
    margin-left: 0 !important;
    margin-right: 0 !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    }
    /* Extra ruimte tussen constructies */
    .regel {
        margin-bottom: 15px;
    }
    /* Afwisselende achtergrondkleur voor constructies */
    .regel:nth-child(even) {
        background-color: #e3f2fd; /* Lichtblauwe achtergrond voor even constructies */
    }
    .regel:nth-child(odd) {
        background-color: #ffffff; /* Witte achtergrond voor oneven constructies */
    }
    
    /* Opmaak monster regels */
    .monster-row {
        display: flex;
        align-items: center;
        gap: 15px; /* Ruimte tussen monsternummer en checkboxes */
        font-size: 16px; /* Grotere tekst voor betere leesbaarheid */
    }
    .monster-nummer {
        flex: 2; /* Zorgt ervoor dat het veld groter wordt ten opzichte van andere elementen */
        width: 100%; /* Zorgt ervoor dat het veld de maximale ruimte benut */
        min-width: 90px; /* Voorkomt dat het veld te klein wordt */
        font-size: 16px; /* Grotere tekst voor betere leesbaarheid */
        padding: 10px; /* Extra binnenruimte voor een groter veld */
        height: 30px; /* Maakt het veld hoger zodat het beter zichtbaar is */
    }
    .analyse-label {
        display: flex;
        align-items: center;
        font-size: 14px;
        gap: 5px;
    }
    </style>
</head>
    
<body>
        
    <div class="container"> <!-- container voor alle elementen op de pagina -->   
        
 <!-- Eerste blok met de titel, projectnummer en knop Begin invullen -->        
    <h3 class="col-md-12 bg-success-subtle text-center">Veldwerktabel chroom-6/lood onderzoek</h3>
        
        <div id="invullen" class="text-left">
            <div class="col-xs-12">
                <label style= "color: red">Projectnummer (verplicht):</label>
                <input type="text" id="projectNummer" class="form-control" placeholder="Voer projectnummer in">
            </div>

            <button id="begin" class="btn btn-primary" type="button" hidden>Begin met invullen</button>
        </div>
    <br>
        
 <!-- Blok "Tabel" met constructies, voortekst en knop Nog een onderdeel wordt zichtbaar bij klikken op Begin-knop -->           
    <div id="tabel">

        <h6 class="text-left">Vul je waarnemingen in (kies uit de drop-down, selecteer een optie of voer handmatig een waarde in)</h6>
        <br>
 
<!-- Blok "Regels" met alle constructies -->   
        <div id="regels">
            
        <!-- eerste constructie "regel" als sjabloon -->
             <div class="regel row">
                 
                 <h5 class="col-xs-12">Constructie 01</h5>
                    <div class="col-xs-12">
                     <input name="onderdeelnr" class="form-control" type="hidden" value="01"> <!-- standaard verborgen -->
                    </div>
                 
                <!-- Drop-down lijst met constructies-->
                 <div class="col-xs-12">
                    <select class="form-control onderdeel-dropdown">
                        <option value="" selected disabled>Kies naam van het onderdeel</option>
                        <option value="Draagconstructie">Draagconstructie</option>
                        <option value="Gevelpanelen buitenzijde">Gevelpanelen buitenzijde</option>
                        <option value="Gevelpanelen binnenzijde">Gevelpanelen binnenzijde</option>
                        <option value="Geveldeuren buitenzijde">Geveldeuren buitenzijde</option>
                        <option value="Geveldeuren binnenzijde">Geveldeuren binnenzijde</option>
                        <option value="Geveldeurkozijnen buitenzijde">Geveldeurkozijnen buitenzijde</option>
                        <option value="Geveldeurkozijnen binnenzijde">Geveldeurkozijnen binnenzijde</option>
                        <option value="Raamkozijnen buiten">Raamkozijnen buitenzijde</option>
                        <option value="Raamkozijnen binnen">Raamkozijnen binnenzijde</option>
                        <option value="Binnendeuren">Binnendeuren</option>
                        <option value="Binnendeurkozijnen">Binnendeurkozijnen</option>
                        <option value="Hemelwaterafvoeren">Hemelwaterafvoeren</option>
                        <option value="Trap en railing buiten">Trap en railing buiten</option>
                        <option value="Trap en railing binnen">Trap en railing binnen</option>
                        <option value="Damwand dakbeschot">Damwand dakbeschot</option>
                        <option value="Hekken">Hekken</option>
                        <option value="Transformatoren">Transformatoren</option>
                        <option value="Schakelaars">Schakelaars</option>
                        <option value="3-fase leidingen">3-fase leidingen</option>
                        <option value="anders">Anders...</option>
                    </select>
                    <!-- Invoerveld dat bewerkbaar is, wordt pas zichtbaar bij het kiezen uit de drop-down -->
                        <input type="text" class="form-control onderdeel-input" placeholder="Voer een onderdeel in" style="display:none;">
                 </div>
                 
                <!-- Opties voor materiaal, staal bij default -->                     
                 <div class="col-xs-12 materiaal-opties">
                        <strong>Selecteer het materiaal van de constructie:</strong><br>
                        <label><input type="radio" name="materiaal-01" value="staal" checked> staal</label>
                        <label><input type="radio" name="materiaal-01" value="aluminium"> aluminium</label>
                        <label><input type="radio" name="materiaal-01" value="koper"> koper</label>
                        <label><input type="radio" name="materiaal-01" value="hout"> hout</label>
                 </div>
                
                <!-- Veld voor aantal verflagen -->
                <div class="col-xs-12">
                        <label>Aantal verflagen:</label>
                        <input name="nrlagen" class="form-control verflaag-input" type="number" min="0" value="0">
                </div>
                <!-- Container waar de kleurvelden worden gegenereerd, bij 0 verflagen niet zichtbaar -->
                <div class="col-xs-12 verf-kleuren"></div>
                 
                 <!-- Drop-down voor chroom-6 testresultaat -->
                <div class="col-xs-12">
                    <label>Sneltest chroom-6:</label>
                    <select name="chroom6_uitslag" class="form-control">
                        <option value="" selected disabled>Selecteer een optie...</option>
                        <option value="negatief">Negatief</option>
                        <option value="licht positief">Licht positief</option>
                        <option value="positief">Positief</option>
                        <option value="sterk positief">Sterk positief</option>
                        <option value="niet uitgevoerd">Niet uitgevoerd</option>
                        <option value="chroom-6 primer visueel herkend">Chroom-6 primer visueel herkend</option>
                        <option value="niet eenduidig">De uitslag niet eenduidig door eigen kleur verf</option>
                    </select>
                </div>

                <!-- Drop-down voor lood testresultaat -->
                <div class="col-xs-12">
                    <label>Sneltest lood:</label>
                    <select name="lood_uitslag" class="form-control">
                        <option value="" selected disabled>Selecteer een optie...</option>
                        <option value="negatief">Negatief</option>
                        <option value="licht positief">Licht positief</option>
                        <option value="positief">Positief</option>
                        <option value="sterk positief">Sterk positief</option>
                        <option value="niet uitgevoerd">Niet uitgevoerd</option>
                        <option value="loodmenie visueel herkend">Loodmenie visueel herkend</option>
                        <option value="niet eenduidig">De uitslag niet eenduidig door eigen kleur verf</option>
                    </select>
                </div>
                 
                <!--Container voor alle monsters incl. knop Nog een monster-->
                <div class="col-xs-12">
                    <label><input type="checkbox" class="monster-checkbox"> Monsters genomen?</label>

                <!-- Container waarin alle monsternummers + checkboxes analyse komen -->
                <!-- Lege container, want wordt gevuld door JS -->
                    <div class="monster-container"></div>

                    <!-- Knop om extra monster-velden toe te voegen (verborgen totdat de checkbox is aangevinkt) -->
                    <button type="button" class="btn btn-light add-monster" style="display: none;">Nog een monster toevoegen</button>
                </div>
                 
                <!-- Opmerkingenveld -->
                <div class="col-xs-12">
                    <br>
                    <label>Opmerkingen:</label>
                    <input type="text" class="form-control opmerkingen-input" placeholder="Noteer hier de eventuele opmerkingen, bijvoorbeeld lengte x breedte monstervlak, dikte constructie etc.">
                </div>
                 
             </div>
        </div>
        
        <br>
        <button id="next" type="button" class="btn btn-info">Nog een onderdeel toevoegen</button>
    </div>
        
 <!-- Hier komt de melding bij het bereiken van max. aantal constructies -->        
        <p id="melding" class="col-md-12 text-left"></p>
    <hr>
        
        
        <button id="tabelSamples" class="btn btn-success">Genereer monstertabel</button>
        <!-- Container voor de gegenereerde monstertabel -->
            <div id="monstertabel-container" class="col-md-12"></div>
    <br>
    <br>
        <button id="exportWord" class="btn btn-warning">Exporteer de samenvattingstabel naar Word</button>
    <br>
    <br>
    <hr>
        <button id="wisGegevens" class="btn btn-danger">Wis gegevens en start nieuw project</button>
        <p id="meldingwis" class="col-md-12 text-left" style="color: red;">Let op, de gegevens kunnen dan niet meer worden hersteld!!!</p>
    </div>     
        
        
    <script>
// Laat de knop 'Begin met invullen' zien als er een projectnummer is ingevuld
    document.getElementById("projectNummer").addEventListener("input", function () {
        const projectNummer = this.value.trim();
        const knopBegin = document.getElementById("begin");
        if (projectNummer !== "") {
            knopBegin.hidden = false; // toon de knop
        } else {
            knopBegin.hidden = true; // verberg de knop
        }
    });
        
// Functie voor de knop Begin met invullen = de tabel zichtbaar maken
    document.getElementById("begin").addEventListener("click", function () {
        const tabel = document.getElementById("tabel");
        const knopBegin = document.getElementById("begin");
        if (tabel.style.display!= "block"){
          tabel.style.display= "block"; // Maak de tabel zichtbaar
          knopBegin.disabled = true; // Blokkeer de knop
        }
    });
        
// Functie voor de knop Nog een onderdeel om een nieuwe constructie toe te voegen
    document.getElementById("next").addEventListener("click", function () {
        var regelsDiv = document.getElementById("regels");
        var bestaandeRegels = document.getElementsByClassName("regel").length;
        var nieuwNummer = (bestaandeRegels + 1).toString().padStart(2, "0"); // Genereert "02", "03", etc.
                
// Maak een nieuwe constructie aan met "regel" als sjabloon
        var nieuweRegel = document.createElement("div");
            nieuweRegel.className = "regel row";
            nieuweRegel.innerHTML = `
        <h5 class="col-xs-12">Constructie ${nieuwNummer}</h5>
        <div class="col-xs-12">
                <input name="onderdeelnr" class="form-control" type="hidden" value="${nieuwNummer}">
        </div>
         <!-- Drop-down lijst met constructies -->
         <div class="col-xs-12">
                <select class="form-control onderdeel-dropdown">
                    <option value="" selected disabled>Kies naam van het onderdeel</option>
                    <option value="Draagconstructie">Draagconstructie</option>
                    <option value="Gevelpanelen buitenzijde">Gevelpanelen buitenzijde</option>
                    <option value="Gevelpanelen binnenzijde">Gevelpanelen binnenzijde</option>
                    <option value="Geveldeuren buitenzijde">Geveldeuren buitenzijde</option>
                    <option value="Geveldeuren buitenzijde">Geveldeuren binnenzijde</option>
                    <option value="Geveldeurkozijnen buitenzijde">Geveldeurkozijnen buitenzijde</option>
                    <option value="Geveldeurkozijnen binnenzijde">Geveldeurkozijnen binnenzijde</option>
                    <option value="Raamkozijnen buitenzijde">Raamkozijnen buitenzijde</option>
                    <option value="Raamkozijnen binnenzijde">Raamkozijnen binnenzijde</option>
                    <option value="Binnendeuren">Binnendeuren</option>
                    <option value="Binnendeurkozijnen">Binnendeurkozijnen</option>
                    <option value="Hemelwaterafvoeren">Hemelwaterafvoeren</option>
                    <option value="Trap en railing buiten">Trap en railing buiten</option>
                    <option value="Trap en railing binnen">Trap en railing binnen</option>
                    <option value="Damwand dakbeschot">Damwand dakbeschot</option>
                    <option value="Hekken">Hekken</option>
                    <option value="Transformatoren">Transformatoren</option>
                    <option value="Schakelaars">Schakelaars</option>
                    <option value="3-fase leidingen">3-fase leidingen</option>
                    <option value="anders">Anders...</option>
                </select>
                <!-- Invoerveld dat bewerkbaar is, wordt pas zichtbaar bij het kiezen uit de drop-down -->
                <input type="text" class="form-control onderdeel-input" placeholder="Voer een onderdeel in" style="display:none;">
            </div>
            
            <!-- Opties voor materiaal, staal bij default --> 
            <div class="col-xs-12 materiaal-opties">     
                    <label><input type="radio" name="materiaal-${nieuwNummer}" value="staal" checked> staal</label>
                    <label><input type="radio" name="materiaal-${nieuwNummer}" value="aluminium"> aluminium</label>
                    <label><input type="radio" name="materiaal-${nieuwNummer}" value="koper"> koper</label>
                    <label><input type="radio" name="materiaal-${nieuwNummer}" value="hout"> hout</label>
            </div>
            
            <!-- Veld voor aantal verflagen -->
            <div class="col-xs-12">
                    <label>Aantal verflagen:</label>
                    <input name="nrlagen" class="form-control verflaag-input" type="number" min="0" value="0">
            </div>
            <!-- Container waar de kleurvelden worden gegenereerd, bij 0 verflagen niet zichtbaar -->
            <div class="col-xs-12 verf-kleuren"></div>
                    
            <!-- Drop-down voor chroom-6 testresultaat -->
            <div class="col-xs-12">
                <label>Sneltest chroom-6:</label>
                <select name="chroom6_uitslag" class="form-control">
                    <option value="" selected disabled>Selecteer een optie...</option>
                    <option value="negatief">Negatief</option>
                    <option value="licht positief">Licht positief</option>
                    <option value="positief">Positief</option>
                    <option value="sterk positief">Sterk positief</option>
                    <option value="niet uitgevoerd">Niet uitgevoerd</option>
                    <option value="chroom-6 primer visueel herkend">Chroom-6 primer visueel herkend</option>
                    <option value="niet eenduidig">De uitslag niet eenduidig door eigen kleur verf</option>
                </select>
            </div>

            <!-- Drop-down voor lood testresultaat -->
            <div class="col-xs-12">
                <label>Sneltest lood:</label>
                <select name="lood_uitslag" class="form-control">
                    <option value="" selected disabled>Selecteer een optie...</option>
                    <option value="negatief">Negatief</option>
                    <option value="licht positief">Licht positief</option>
                    <option value="positief">Positief</option>
                    <option value="sterk positief">Sterk positief</option>
                    <option value="niet uitgevoerd">Niet uitgevoerd</option>
                    <option value="loodmenie visueel herkend">Loodmenie visueel herkend</option>
                    <option value="niet eenduidig">De uitslag niet eenduidig door eigen kleur verf</option>
                </select>
            </div>
            
            <!--Container voor alle monsters incl. knop Nog een monster-->
            <div class="col-xs-12">
                <label><input type="checkbox" class="monster-checkbox"> Monsters genomen?</label>

                <!-- Container waarin alle monsternummers + checkboxes analyse komen -->
                <!-- Lege container, want wordt gevuld door JS -->
                <div class="monster-container"></div>
                
        
                <!-- Knop om extra monster-velden toe te voegen (verborgen totdat de checkbox is aangevinkt) -->
                <button type="button" class="btn btn-light add-monster" style="display: none;">Nog een monster toevoegen</button>
                
            <!-- Opmerkingenveld -->
            <div class="col-xs-12">
                <br>
                <label>Opmerkingen:</label>
                <input type="text" class="form-control opmerkingen-input" placeholder="Noteer hier de eventuele opmerkingen, bijvoorbeeld lengte x breedte monstervlak, dikte constructie etc.">
            </div>
            
            </div>
            `;
        
    regelsDiv.appendChild(nieuweRegel); // Voegt de nieuwe regel toe aan de tabel

    configureDropdowns(nieuweRegel); // De nieuwe dropdown en input-veld werken zoals in de eerste regel (zie functie onder)
        
// Controle of het aantal regels al het maximale aantal is
    var melding=document.getElementById("melding");
    if (document.getElementsByClassName("regel").length >= 100) {
        melding.innerHTML="Je kunt maximaal 100 regels toevoegen.";
        melding.style.color="red";
        document.getElementById("next").disabled = true; // Knop uitschakelen bij limiet bereikt
    }else {
        melding.innerHTML = ""; // Melding wissen als limiet niet bereikt is
    };
});
        
// Functie bij het kiezen van de constructie uit de drop-down 
    function configureDropdowns(regel) {  
        const dropdown = regel.querySelector(".onderdeel-dropdown");
        const inputField = regel.querySelector(".onderdeel-input");
        
        dropdown.addEventListener("change", function () {
            if (this.value === "anders") {
                inputField.style.display = "block"; // Toon invoerveld
                inputField.value = ""; // Maak invoerveld leeg
                inputField.focus();
            } else {
                inputField.style.display = "block"; // Toon invoerveld
                inputField.value = this.value; // Vul het invoerveld met de gekozen waarde
            }
        });
        inputField.addEventListener("input", function () {
            dropdown.value = "anders"; // "Anders..." wordt geselecteerd als er een aanpassing is in vrij input-veld
        });
    }
// Loopt door alle constructieregels van het formulier, en activeert de dropdown-functionaliteit voor elk van die regels         
    document.querySelectorAll(".regel").forEach(configureDropdowns);
        
        
        
// BLOK KLEURLAGEN        
// Functie om kleurvelden toe te voegen op basis van het ingevulde aantal verflagen             
    document.addEventListener("input", function (event) {
    if (event.target.classList.contains("verflaag-input")) {
        var aantalLagen = parseInt(event.target.value) || 0; // 0 als standaardwaarde toegestaan
        var kleurContainer = event.target.closest(".regel").querySelector(".verf-kleuren");

      kleurContainer.innerHTML = "";   // Verwijdert bestaande invoervelden

    // Functie om nieuwe kleurvelden te genereren voor het ingevulde aantal lagen; Genereert alleen velden als het aantal > 0 is
        if (aantalLagen > 0) {
        for (var i = 0; i < aantalLagen; i++) {
            var kleurLabel = document.createElement("label");
            kleurLabel.textContent = "Kleur laag " + (i + 1) + ":";

            var kleurInput = document.createElement("input");
            kleurInput.type = "text";
            kleurInput.name = "kleurlaag" + (i + 1);
            kleurInput.className = "form-control";
            kleurInput.placeholder = "Voer kleur in";

            kleurContainer.appendChild(kleurLabel); // Label en invoerveld worden toegevoegd aan de container met kleuren
            kleurContainer.appendChild(kleurInput);
                }
            }
        }
    });
            
 
        
// BLOK MONSTERS    
// Functie om de eerste monsterregel toe te voegen bij aanvinken check-box Monsters genomen
    document.addEventListener("change", function (event) {
        if (event.target.classList.contains("monster-checkbox")) {
            var regel = event.target.closest(".regel");
            var monsterContainer = regel.querySelector(".monster-container");
            var addMonsterButton = regel.querySelector(".add-monster");

            if (!event.target.checked) {             // Monstercontainer en knop verwijderen bij uitvinken check-box
                monsterContainer.innerHTML = "";
                addMonsterButton.style.display = "none";
                return;
            }

    // Voegt de eerste monster-item toe of toont het bestaande
    let bestaandItem = monsterContainer.querySelector(".monster-item");

    if (!bestaandItem) {              // Geen monster-item? (bij eerste keer aanvinken) Voeg hem toe:
        const eersteMonster = document.createElement("div");
        eersteMonster.className = "monster-item";
        eersteMonster.innerHTML = `
            <div class="monster-row">
                <input type="text" class="form-control monster-nummer" placeholder="Voer monsternummer in">
                <label class="analyse-label">
                    <input type="checkbox" class="analyse-chroom6"> Analyse op chroom-6
                </label>
                <label class="analyse-label">
                    <input type="checkbox" class="analyse-lood"> Analyse op lood
                </label>
            </div>
        `;
        monsterContainer.appendChild(eersteMonster);
        
    const monsterInput = eersteMonster.querySelector(".monster-nummer");
    monsterInput.style.display = "block"; // maakt zichtbaar (indien niet al in de HTML)
    monsterInput.focus();   
        
    } else {                         // Wel een monster-item aanwezig? Dan worden alle velden zichtbaar
        bestaandItem.querySelector(".monster-nummer").style.display = "block";
        bestaandItem.querySelectorAll(".analyse-label").forEach(label => {
            label.style.display = "flex";
        });
    }

    // De knop om extra monsters toe te voegen wordt zichtbaar bij het aanvinken check-box Monsters genomen
        addMonsterButton.style.display = "inline-block";
    }
});
        
// Functie om extra monster-velden toe te voegen met checkboxes bij het klikken op Monster toevoegen
    document.addEventListener("click", function (event) {
        if (event.target.classList.contains("add-monster")) {
        var monsterContainer = event.target.closest(".col-xs-12").querySelector(".monster-container");

    // Maakt een nieuw monster-item met checkboxes aan (standaard zichtbaar als "Monsters genomen?" aan staat)
        var newMonsterItem = document.createElement("div");
        newMonsterItem.className = "monster-item";
        newMonsterItem.innerHTML = `
        <div class="monster-row">
            <input type="text" class="form-control monster-nummer" placeholder="Voer extra monsternummer in">
            <label class="analyse-label">
                <input type="checkbox" class="analyse-chroom6"> Analyse op chroom-6
            </label>
            <label class="analyse-label">
                <input type="checkbox" class="analyse-lood"> Analyse op lood
            </label>
        </div>
        `;
        monsterContainer.appendChild(newMonsterItem);
        newMonsterItem.querySelector(".monster-nummer").focus();
    }
});

        
        
// BLOK OPSLAAN        
    
// Functie alle gegevens automatisch opslaan wanneer de gebruiker iets invoert       
    function saveData() {
        let projectNummer = document.getElementById("projectNummer").value;
        if (!projectNummer) return;                       // Geen projectnummer? Niet opslaan.

        let projectData = [];

        document.querySelectorAll(".regel").forEach((regel, index) => {
            let dropdown = regel.querySelector(".onderdeel-dropdown");
            let inputField = regel.querySelector(".onderdeel-input");
            let onderdeel = dropdown.value === "anders" ? inputField.value : dropdown.value;
            let materiaal = regel.querySelector('input[name^="materiaal"]:checked')?.value || "";
            let nrlagen = regel.querySelector(".verflaag-input").value || "0";
            let kleuren = Array.from(regel.querySelectorAll(".verf-kleuren input")).map(input => input.value);
            let chroom6 = regel.querySelector("select[name='chroom6_uitslag']").value || "";
            let lood = regel.querySelector("select[name='lood_uitslag']").value || "";
            
            let monsters = [];
                regel.querySelectorAll(".monster-item").forEach(monster => {
                    let monsterNummer = monster.querySelector(".monster-nummer").value || "";
                    let analyseChroom6 = monster.querySelector(".analyse-chroom6")?.checked || false;
                    let analyseLood = monster.querySelector(".analyse-lood")?.checked || false;
                    if (monsterNummer) {
                        monsters.push({ monsterNummer, analyseChroom6, analyseLood });
                    }
                });
            let opmerkingen = regel.querySelector(".opmerkingen-input")?.value || "";
            
            projectData.push({ onderdeel, materiaal, nrlagen, kleuren, chroom6, lood, monsters, opmerkingen });
        });

    localStorage.setItem(`projectData_${projectNummer}`, JSON.stringify(projectData));
    };

// Het projectnummer wordt automatisch opgeslagen en gekoppeld aan de juiste gegevens
    document.getElementById("projectNummer").addEventListener("input", function () {
        localStorage.setItem("projectNummer", this.value);
    });

//Alle velden worden automatisch opgeslagen bij input of aanpassing
    document.addEventListener("input", saveData);
    document.addEventListener("change", saveData);
            
//Functie om alle gegevens te wissen en een nieuwe vorm te laden bij het klikken op Wis gegevens
    document.getElementById("wisGegevens").addEventListener("click", function () {
        let projectNummer = document.getElementById("projectNummer").value;
        if (!projectNummer) return; // Als er geen projectnummer is, doe niets

        if (confirm("Weet je zeker dat je alle gegevens wilt wissen? Dit kan niet ongedaan worden gemaakt.")) {
            localStorage.removeItem(`projectData_${projectNummer}`); // Verwijder opgeslagen projectgegevens
            localStorage.removeItem("projectNummer"); // Verwijder het projectnummer
            document.getElementById("projectNummer").value = ""; // Leeg het projectnummer veld

            document.getElementById("regels").innerHTML = "";   // Leegt de vorm en zet deze terug naar standaard

            alert("Alle gegevens zijn gewist!");
            
            location.reload();
        }
    });

// Functie om alle opgeslagen gegevens te herstellen als de pagina per ongeluk wordt ververst
    function loadData() {
    let projectNummer = localStorage.getItem("projectNummer"); 
    if (!projectNummer) return; // Geen projectnummer? Niets laden.

    document.getElementById("projectNummer").value = projectNummer; // De opgeslagen projectnummer terugzetten
    let savedData = localStorage.getItem(`projectData_${projectNummer}`);
    if (!savedData) return; // Geen opgeslagen gegevens? Niets laden.
    savedData = JSON.parse(savedData);
        
    let regelsDiv = document.getElementById("regels");   
    regelsDiv.innerHTML = ""; // Oude regels verwijderen

    savedData.forEach((data, index) => {
        document.getElementById("next").click(); // Voegt een nieuwe regel toe voor elke opgeslagen constructie
        let regel = document.querySelectorAll(".regel")[index];

        // Invullen constructienamen
        let dropdown = regel.querySelector(".onderdeel-dropdown");
        let inputField = regel.querySelector(".onderdeel-input");

        // Als de opgeslagen waarde niet voorkomt in de opties van de dropdown, dan is het een vrije invoer
        let isAnders = !Array.from(dropdown.options).some(option => option.value === data.onderdeel);

        // Als het een vrije invoer is, zet dan de dropdown op "Anders" en toon de ingevoerde waarde
        if (isAnders) {
            dropdown.value = "anders";
            inputField.style.display = "block"; 
            inputField.value = data.onderdeel; 
        } else {
            dropdown.value = data.onderdeel; 
            inputField.style.display = "none"; 
        }
        
        // Invullen materiaal en aantal verflagen
        regel.querySelector(`input[name^="materiaal"][value="${data.materiaal}"]`)?.click();
        regel.querySelector(".verflaag-input").value = data.nrlagen;

        // Invullen kleur verflagen
        let kleurContainer = regel.querySelector(".verf-kleuren");
        kleurContainer.innerHTML = "";
        data.kleuren.forEach((kleur, i) => {
            let kleurLabel = document.createElement("label");
            kleurLabel.textContent = "Kleur laag " + (i + 1) + ":";
            
            let kleurInput = document.createElement("input");
            kleurInput.type = "text";
            kleurInput.className = "form-control";
            kleurInput.placeholder = `Kleur laag ${i + 1}`;
            kleurInput.value = kleur;
            
            kleurContainer.appendChild(kleurLabel);
            kleurContainer.appendChild(kleurInput);
        });
        
        // Invullen sneltesten uitslag
        regel.querySelector("select[name='chroom6_uitslag']").value = data.chroom6;
        regel.querySelector("select[name='lood_uitslag']").value = data.lood;

        // Invullen monsters
        if (data.monsters.length > 0) {
            let monsterCheckbox = regel.querySelector(".monster-checkbox");
            monsterCheckbox.checked = true;
            monsterCheckbox.dispatchEvent(new Event("change")); // Activeert de checkbox
            
            let monsterContainer = regel.querySelector(".monster-container");
            monsterContainer.innerHTML = ""; // Verwijdert eventuele oude monsters

            data.monsters.forEach(monster => {
                let monsterItem = document.createElement("div");
                monsterItem.className = "monster-item";
                monsterItem.innerHTML = `
                    <div class="monster-row">
                        <input type="text" class="form-control monster-nummer" placeholder="Voer monsternummer in" value="${monster.monsterNummer}">
                        <label class="analyse-label">
                            <input type="checkbox" class="analyse-chroom6" ${monster.analyseChroom6 ? "checked" : ""}> Analyse op chroom-6
                        </label>
                        <label class="analyse-label">
                            <input type="checkbox" class="analyse-lood" ${monster.analyseLood ? "checked" : ""}> Analyse op lood
                        </label>
                    </div>
                `;
                monsterContainer.appendChild(monsterItem);
                });
            
            regel.querySelector(".add-monster").style.display = "inline-block"; // Maakt de knop Nog een monster zichtbaar
            
            }
        
         // Invullen opemrkingen
        regel.querySelector(".opmerkingen-input").value = data.opmerkingen || "";
        
        });
    }

//Functie om alle opgeslagen gegevens terug te zetten
    window.addEventListener("load", function () {
        const projectNummer = localStorage.getItem("projectNummer");
        const opgeslagenData = localStorage.getItem(`projectData_${projectNummer}`);

        // Zet projectnummer in het veld
        if (projectNummer) {
            document.getElementById("projectNummer").value = projectNummer;
        }

        // Laad data als die er is
        if (projectNummer && opgeslagenData) {
            document.getElementById("tabel").style.display = "block";
            document.getElementById("begin").disabled = true;
            document.getElementById("begin").hidden = true;

            loadData(); // Laad direct de opgeslagen gegevens
        } 
    });

        
        

// BLOK MONSTERTABEL
    
// Functie monstertabel toevoegen bij het klikken op Genereer monstertabel         
    document.getElementById("tabelSamples").addEventListener("click", function () {
        let tabelContainer = document.getElementById("monstertabel-container");
        tabelContainer.innerHTML = ""; // Leegt de bestaande tabel als deze al bestaat

        let regels = document.querySelectorAll(".regel");
        let tabelHTML = `
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Constructie</th>
                        <th>Monsternummer</th>
                        <th>Analyses</th>
                    </tr>
                </thead>
                <tbody>`;

        regels.forEach(regel => {
            let constructieNummer = regel.querySelector("input[name='onderdeelnr']").value;
            let dropdown = regel.querySelector(".onderdeel-dropdown");
            let inputField = regel.querySelector(".onderdeel-input");

            // Controleer of "Anders" is gekozen
            let constructieNaam = dropdown.value === "anders" ? inputField.value.trim() : dropdown.value;

            // Als zowel de dropdown als de invoer leeg zijn, toon "Onbekend"
            if (!constructieNaam) constructieNaam = "Onbekend";

            let monsterCheckbox = regel.querySelector(".monster-checkbox");

            let monsterItems = regel.querySelectorAll(".monster-item");
            let heeftMonsters = monsterItems.length > 0;
        
            if (heeftMonsters) {
            monsterItems.forEach(monster => {
                let monsternummer = monster.querySelector(".monster-nummer").value.trim();
                if (monsternummer) { // Alleen toevoegen als er een monsternummer is ingevoerd
                    let analyseChroom6 = monster.querySelector(".analyse-chroom6").checked;
                    let analyseLood = monster.querySelector(".analyse-lood").checked;
                    let analyses = [];

                    if (analyseChroom6) analyses.push("chroom-6");
                    if (analyseLood) analyses.push("lood");

                    let analyseText = analyses.length > 1 ? "chroom-6 plus lood" : analyses.join(", ") || "Geen";

                    tabelHTML += `
                        <tr>
                            <td>${constructieNummer}. ${constructieNaam}</td>
                            <td>${monsternummer}</td>
                            <td>${analyseText}</td>
                        </tr>`;
                    }
                });
            }
        
        // Voeg constructie toe zonder monsters
        if (!monsterCheckbox.checked) {
            tabelHTML += `
                <tr>
                    <td>${constructieNummer}. ${constructieNaam}</td>
                    <td>geen monsters</td>
                    <td></td>
                </tr>`;
            }
        });

        tabelHTML += `</tbody></table>`;

    // Alleen de tabel tonen als er daadwerkelijk monsters zijn
        if (tabelHTML.includes("<td>")) {
            tabelContainer.innerHTML = tabelHTML;
        } else {
            tabelContainer.innerHTML = "<p class='text-warning'>Geen monsters geregistreerd.</p>";
        }
        });

            
    document.addEventListener("DOMContentLoaded", function () {
    console.log("Pagina geladen. Docxtemplater beschikbaar?", typeof window.Docxtemplater);
});


            
            
// Functie om de monstertabelgegevens op te halen en om te zetten naar een Word-bestand
    document.getElementById("exportWord").addEventListener("click", function () {
    console.log("Start export naar Word...");
    
    fetch("sjabloon_samenvatting_v2.docx") // Zorg dat het juiste sjabloon in de map staat
        .then(res => {
            if (!res.ok) {
                throw new Error("Kan sjabloonbestand niet laden. Controleer het pad!");
            }
            return res.arrayBuffer();
        })
        .then(content => {
            let zip = new PizZip(content);
            let doc = new window.docxtemplater(zip, { paragraphLoop: true, linebreaks: true });

            //Gegevens verzamelen uit de monstertabel
            let regels = document.querySelectorAll(".regel");
            let tabelData = [];

            regels.forEach(regel => {
                let constructieNummer = regel.querySelector("input[name='onderdeelnr']").value;
                let dropdown = regel.querySelector(".onderdeel-dropdown");
                let inputField = regel.querySelector(".onderdeel-input");

                // Controleer of "Anders" is gekozen, dan gebruik de ingevulde tekst
                let constructieNaam = dropdown.value === "anders" ? inputField.value.trim() : dropdown.value;

                // Als zowel de dropdown als de invoer leeg zijn, toon "Onbekend"
                if (!constructieNaam) constructieNaam = "Onbekend";
                
                let verfLagen = Array.from(regel.querySelectorAll(".verf-kleuren input"))
                                    .map(input => input.value).join(", ");
                let chroom6Resultaat = regel.querySelector("select[name='chroom6_uitslag']").value || "Niet uitgevoerd";
                let loodResultaat = regel.querySelector("select[name='lood_uitslag']").value || "Niet uitgevoerd";

                let monsterCheckbox = regel.querySelector(".monster-checkbox");
                let monsterItems = regel.querySelectorAll(".monster-item");
                
                let opmerkingen = regel.querySelector(".opmerkingen-input")?.value || "";

                if (monsterCheckbox.checked && monsterItems.length > 0) {   // Voeg constructie toe met monsters
                    monsterItems.forEach(monster => {
                        let monsternummer = monster.querySelector(".monster-nummer").value.trim();
                        if (monsternummer) {
                            let analyseChroom6 = monster.querySelector(".analyse-chroom6").checked;
                            let analyseLood = monster.querySelector(".analyse-lood").checked;
                            let analyses = [];
                            if (analyseChroom6) analyses.push("analyse chroom-6");
                            if (analyseLood) analyses.push("analyse lood");
                            
                            let gehalteChroom = analyseChroom6 ? "**analyse chroom-6**" : "geen analyse"; 
                            let gehalteLood = analyseLood ? "**analyse lood**" : "geen analyse";

                            tabelData.push({
                                onderdeel: constructieNummer + ". " + constructieNaam,
                                monsterNr: monsternummer,
                                verfsysteem: verfLagen.replace(/\n/g, "\r\n"), 
                                sneltest_chroom: chroom6Resultaat,
                                sneltest_lood: loodResultaat,
                                gehalte_chroom: gehalteChroom, 
                                gehalte_lood: gehalteLood,
                                opmerkingen: opmerkingen,
                            });
                        }
                    });
                        } else {                            // Voeg constructie toe zonder monsters
                            tabelData.push({
                                onderdeel: constructieNummer + ". " + constructieNaam,
                                monsterNr: "geen monsters",
                                verfsysteem: verfLagen.replace(/\n/g, "\r\n"),
                                sneltest_chroom: chroom6Resultaat,
                                sneltest_lood: loodResultaat,
                                gehalte_chroom: "geen analyse", 
                                gehalte_lood: "geen analyse",
                                opmerkingen: opmerkingen,
                            });
                        }
                    });
        
            doc.setData({ tabel: tabelData });

            try {
                doc.render();
                let out = doc.getZip().generate({ type: "blob", mimeType: "application/vnd.openxmlformats-officedocument.wordprocessingml.document" });
                saveAs(out, "Samenvatting_analyse.docx");
                console.log("Word-bestand gegenereerd en gedownload.");
            } catch (error) {
                console.error("Fout bij genereren en downloaden van Word-bestand:", error);
            }
        })
        .catch(err => console.error("Fout bij genereren Word-bestand:", err));
    });

    </script>
        
</body>
</html>

